<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <title>AI 图片爬虫</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen">
  <div id="app" class="w-full max-w-md bg-white rounded-2xl shadow-xl p-8 space-y-6">
    <h1 class="text-2xl font-bold text-center text-indigo-600">AI 图片爬虫 & 自动标注</h1>

    <div>
      <label class="block text-sm font-medium text-slate-700">关键词</label>
      <input id="keyword" value="cat"
             class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"/>
    </div>

    <div>
      <label class="block text-sm font-medium text-slate-700">最大张数</label>
      <input id="num_img" type="number" value="10"
             class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"/>
    </div>

    <button id="runBtn"
            class="w-full flex justify-center items-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
      开始抓取
    </button>

    <!-- 进度区 -->
    <div id="progressArea" class="hidden space-y-2">
      <div class="text-sm text-slate-600">实时进度：</div>
      <div class="w-full bg-slate-200 rounded-full h-2.5">
        <div id="progressBar" class="bg-indigo-500 h-2.5 rounded-full" style="width:0%"></div>
      </div>
      <ul id="log" class="text-xs text-slate-500 h-24 overflow-y-auto border rounded p-2 bg-slate-50"></ul>
    </div>
  </div>

  <script>
    // 1. 改成你的 Webhook/SSE 地址
    const WEBHOOK_URL = 'http://localhost:5678/webhook-test/runcrawl';
    const SSE_URL      = 'http://localhost:5678/webhook-test/progress';  // 下面会教你建这个

    const btn        = document.getElementById('runBtn');
    const progress   = document.getElementById('progressArea');
    const bar        = document.getElementById('progressBar');
    const log        = document.getElementById('log');

    btn.onclick = async () => {
      btn.disabled = true;
      btn.textContent = '执行中...';
      progress.classList.remove('hidden');
      bar.style.width = '0%';
      log.innerHTML   = '';

      // 1) 触发工作流
      const body = {
        keyword: document.getElementById('keyword').value,
        num_img: Number(document.getElementById('num_img').value)
      };

      const resp = await fetch(WEBHOOK_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });

      if (!resp.ok) {
        alert(await resp.text());
        reset();
        return;
      }

      // 2) 监听 SSE 进度
      const source = new EventSource(`${SSE_URL}?session=${Date.now()}`);
      source.onmessage = e => {
        const data = JSON.parse(e.data);
        bar.style.width = `${data.percent}%`;
        log.insertAdjacentHTML('beforeend', `<li>${data.msg}</li>`);
        log.scrollTop = log.scrollHeight;

        if (data.percent === 100) {
          source.close();
          // 3) 下载 zip
          resp.blob().then(blob => {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `result_${body.keyword}.zip`;
            a.click();
            URL.revokeObjectURL(url);
            reset();
          });
        }
      };
      source.onerror = () => { source.close(); reset(); };
    };

    function reset() {
      btn.disabled = false;
      btn.textContent = '开始抓取';
    }
  </script>
</body>
</html>